<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>项目中node_modules里面的那些无用包 | buuug</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Blog">
    
    <link rel="preload" href="/assets/css/0.styles.a509abab.css" as="style"><link rel="preload" href="/assets/js/app.b8096a98.js" as="script"><link rel="preload" href="/assets/js/21.bf7b29c4.js" as="script"><link rel="preload" href="/assets/js/2.f7c58a73.js" as="script"><link rel="preload" href="/assets/js/5.79fff311.js" as="script"><link rel="prefetch" href="/assets/js/10.9f899a40.js"><link rel="prefetch" href="/assets/js/11.2d977f36.js"><link rel="prefetch" href="/assets/js/12.6a78c77b.js"><link rel="prefetch" href="/assets/js/13.fbdd2dbb.js"><link rel="prefetch" href="/assets/js/14.a0e94ab5.js"><link rel="prefetch" href="/assets/js/15.14696e5f.js"><link rel="prefetch" href="/assets/js/16.b4d7f12b.js"><link rel="prefetch" href="/assets/js/17.a1268fee.js"><link rel="prefetch" href="/assets/js/18.e006a18f.js"><link rel="prefetch" href="/assets/js/19.dc652960.js"><link rel="prefetch" href="/assets/js/20.6871ee84.js"><link rel="prefetch" href="/assets/js/22.2b187d4a.js"><link rel="prefetch" href="/assets/js/23.b378ab73.js"><link rel="prefetch" href="/assets/js/24.7f821dca.js"><link rel="prefetch" href="/assets/js/25.3094cca7.js"><link rel="prefetch" href="/assets/js/26.b63bfa1d.js"><link rel="prefetch" href="/assets/js/27.05317306.js"><link rel="prefetch" href="/assets/js/28.5df471f1.js"><link rel="prefetch" href="/assets/js/29.460f4c4f.js"><link rel="prefetch" href="/assets/js/3.f9c8446f.js"><link rel="prefetch" href="/assets/js/30.dad3cbd3.js"><link rel="prefetch" href="/assets/js/31.f23cdcc2.js"><link rel="prefetch" href="/assets/js/32.b5d5a2db.js"><link rel="prefetch" href="/assets/js/33.af894eae.js"><link rel="prefetch" href="/assets/js/4.0bce2d4a.js"><link rel="prefetch" href="/assets/js/6.ff667613.js"><link rel="prefetch" href="/assets/js/7.a5829279.js"><link rel="prefetch" href="/assets/js/8.61c949c0.js"><link rel="prefetch" href="/assets/js/9.968eca4f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a509abab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">buuug</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题列表" class="dropdown-title"><span class="title">专题列表</span> <span class="arrow down"></span></button> <button type="button" aria-label="专题列表" class="mobile-dropdown-title"><span class="title">专题列表</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link router-link-active">
  随便写写
</a></li><li class="dropdown-item"><!----> <a href="/chromium/" class="nav-link">
  chromium
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题列表" class="dropdown-title"><span class="title">专题列表</span> <span class="arrow down"></span></button> <button type="button" aria-label="专题列表" class="mobile-dropdown-title"><span class="title">专题列表</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link router-link-active">
  随便写写
</a></li><li class="dropdown-item"><!----> <a href="/chromium/" class="nav-link">
  chromium
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/other/requestIdleCallback/" class="sidebar-link">requestIdleCallback</a></li><li><a href="/other/%E8%B7%A8%E7%AB%AF%E6%9D%82%E8%B0%88/" class="sidebar-link">跨端杂谈</a></li><li><a href="/other/npm/" aria-current="page" class="active sidebar-link">node_modules里面的无用包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/npm/#npm2的依赖管理" class="sidebar-link">npm2的依赖管理</a></li><li class="sidebar-sub-header"><a href="/other/npm/#npm3-yarn的依赖管理" class="sidebar-link">npm3/yarn的依赖管理</a></li><li class="sidebar-sub-header"><a href="/other/npm/#pnpm的依赖管理" class="sidebar-link">pnpm的依赖管理</a></li></ul></li><li><a href="/other/chromedevtool/" class="sidebar-link">chrome devtools</a></li><li><a href="/other/blob&amp;webwork/" class="sidebar-link">基于blob对象动态封装一个web worker</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="项目中node-modules里面的那些无用包"><a href="#项目中node-modules里面的那些无用包" class="header-anchor">#</a> 项目中node_modules里面的那些无用包</h1> <p>相信大家在开发过程中执行<code>yarn</code>或者<code>npm i</code>的时候都会发现一个问题, 明明我的项目只依赖几个<code>npm</code>包, 但是执行完命令后<code>node_modules</code>里面却多出了超级多没见过的无用包?这就和依赖的处理方式有关了, 今天我们就来聊聊这部分的内容.</p> <h2 id="npm2的依赖管理"><a href="#npm2的依赖管理" class="header-anchor">#</a> npm2的依赖管理</h2> <p><code>npm2</code> 安装依赖的时候比较简单直接, 直接按照包依赖的树形结构下载填充本地目录结构.
比如在项目中 <code>A</code> 和 <code>C</code> 都依赖 <code>B</code> , 无论被依赖的 <code>B</code> 是否是同一个版本, 都会直接无脑的生成对应的树结构, 比如我们现在有下面的依赖:
A@2.0.0: BaseA@1.0.0 BaseB@2.0.0
B@3.0.0: BaseA@1.0.0 BaseB@2.0.1
那么 <code>npm i</code> 之后 <code>node_modules</code> 里面生成的内容将是下面这样的</p> <p><img src="/assets/img/npm2.7bf69ce9.png" alt=""></p> <p>这样的结构非常直观, 但是有一个问题就是, 如果项目的依赖过多的话, 可能导致下面这些问题:</p> <ol><li><p>生成的依赖嵌套非常深</p></li> <li><p>相同版本的依赖大量冗余</p></li></ol> <h2 id="npm3-yarn的依赖管理"><a href="#npm3-yarn的依赖管理" class="header-anchor">#</a> npm3/yarn的依赖管理</h2> <p><code>npm3</code> 对于 <code>npm2</code> 的情况进行了优化, 那么如何进行优化呢?其实我们最直观的思路就是将树打平, 将依赖扁平化, 不就能解决嵌套过深和依赖冗余的问题.所以, 在上面的例子中, 如果我们用 <code>npm3</code> 来进行 <code>install</code> , 最后生成的 <code>node_modules</code> 会是这样的结构:</p> <p><img src="/assets/img/npm3.624229b0.png" alt=""></p> <p>这样看起来是不是就好多了, 但是此时会有什么问题呢?我们实操一下试试看.在项目中安装 <code>A</code> 和 <code>B</code></p> <p><img src="/assets/img/A&amp;B.83e8d424.png" alt=""></p> <p>可以看到我们项目本身的依赖文件里面只有 <code>a_klx</code> 和 <code>b_klx</code> , 但是执行完 <code>npm i</code> 命令后却发现多了几个我们没有引入的包 <code>a_base_klx</code> 和 <code>b_base_klx</code> .
其实这是由 <code>a_klx</code> 和 <code>b_klx</code> 本身自己引入的 <code>npm</code> 包, 但是却出现在了我们的 <code>node_modules</code> 下.那么如果我们直接使用这两个包会有什么反应呢?</p> <p><img src="/assets/img/redundant.f7df0d93.png" alt=""></p> <p>可以看到, 我们是可以正常使用这两个我们并未声明在依赖中的 <code>npm</code> 包的, 因为这两个包存在于我们项目的 <code>node_modules</code> 下, 根据 <code>npm</code> 包的查找规则, 我们是可以找到这两个包的.所以这种依赖关系就导致了下面两个问题:</p> <ol><li><p>我们项目本身的 <code>node_modules</code> 结构不够直观</p></li> <li><p>依赖不安全, 我们可以使用依赖文件中并没有声明的 <code>npm</code> 包</p></li></ol> <p>其实第一点的问题并不是很大, 主要是第二点可能会导致一些奇怪的问题.以我们之前的例子来说, 我们可以直接在项目里面直接使用 <code>a_base_klx</code> , 因为 <code>node_modules</code> 里面这两个包实际上是存在的, 但是他们又不是永远存在的.万一有一天,  <code>a_klx</code> 和 <code>b_klx</code> 里都去除了这两个基础包的引用,  <code>node_modules</code> 里面将不再存在 <code>a_base_klx</code> 和 <code>b_base_klx</code> , 那么我们的代码就会出现问题...也就是:</p> <div class="custom-block danger"><p class="custom-block-title">DANGER</p> <p>我的代码啥也没动, 放了一个晚上就坏了​</p></div> <p>同时, 我们对于这种处理方式其实很容易有一个疑问, 如果我同时引用了同一个包的多个不同版本, 会帮我把哪个包提出来, 同时我每次 <code>npm i</code> 之后提出来的包版本都是一样的吗?会不会存在这次是 <code>2.0.0</code> 版本下次是 <code>2.0.1</code> 版本的情况, 比如我们下面这种情况:
A@1.0.0: BaseA@1.0.0 BaseB@2.0.0
B@1.0.0: BaseA@1.0.0 BaseB@2.0.1
D@1.0.0: BaseA@1.0.0 BaseB@2.0.1
生成的依赖是下面这样的:</p> <p><img src="/assets/img/image-15-1636814893552.3d26563b.png" alt=""></p> <p>还是下面这样的:</p> <p><img src="/assets/img/image-16-1636814893753.863584b3.png" alt=""></p> <p>其实看起来后面这个更合理, 因为有两个包用到了 <code>2.0.1</code> 版本, 将它提出来更好, 我们实际操作一下试试:</p> <p><img src="/assets/img/image-17-1636814894154.3955723b.png" alt=""></p> <p>被提到最外层的包是 <code>2.0.0</code> 版本的, 然后 <code>b_klx</code> 和 <code>d_klx</code> 的 <code>node_modules</code> 下面各自有一个 <code>b_base_klx@2.0.1</code>
这一块的内容自己查了一下, 大部分说法是会根据 <code>package.json</code> 里面的顺序决定谁会被提出来, 放在前面的包依赖的内容会被先提出来.</p> <p><img src="/assets/img/image-18-1636814894557.c4b7bf53.png" alt=""></p> <p>不过自己实操了一下发现并不是这样, 即使我把 <code>b_klx</code> 或者 <code>d_klx</code> 移到最前面, 被提出来的包依然是 <code>a_klx</code> 依赖的 <code>2.0.0</code> 版本, 随后自己翻了一下 <code>npm</code> 的源码, 发现内部其实会对拿到的依赖列表进行一些处理
<img src="/assets/img/image-19-1636814894959.7fed88a9.png" alt="">
最终会通过 <code>localeCompare</code> 方法对依赖进行一次排序, 所以字典序在前面的 <code>npm</code> 包的底层依赖会被优先提出来, 对于我们的例子来说就是 <code>a_klx</code> 所依赖的 <code>b_base_klx@2.0.0</code> 会被优先提出来.</p> <h2 id="pnpm的依赖管理"><a href="#pnpm的依赖管理" class="header-anchor">#</a> pnpm的依赖管理</h2> <p><code>pnpm</code> 为了解决上述这些问题, 采用了一种不同于 <code>npm/yarn</code> 的依赖管理方式.</p> <p>如果我们用 <code>pnpm</code> 再来安装一遍上面的依赖, 会发现项目的 <code>node_modules</code> 文件夹只有当前 <code>package.json</code> 中所声明的各个依赖（的软连接）, 而真正的模块文件, 存在于 <code>node_modules/.pnpm</code> , 由 <code>模块名@版本号</code> 形式的文件夹扁平化存储(解决依赖重复安装).同时这样设计, 也很好的避免了之前可以访问非法 <code>npm</code> 包的问题, 因为当前项目的 <code>node_modules</code> 只有我们声明过的依赖, 这也让 <code>node_modules</code> 里面的文件看起来非常的直观.</p> <p><img src="/assets/img/image-20-1636814895563.01933d03.png" alt=""></p> <p>同时,  <code>node_modules/.pnpm</code> 中存储的文件其实是 <code>pnpm</code> 实际缓存文件的 <strong>硬链接</strong> , 从而避免了多个项目带来多份相同文件引起的空间浪费问题.
但是从 <code>pnpm</code> 的 <a href="https://pnpm.io/npmrc#package-import-method" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来看, 其实它默认会使用 <code>copy-on-write</code> 的方式来进行处理, 也就是如果你尝试对内容进行修改的话, 会复制一份文件而不会影响到源文件.
然后它不生效的原因似乎是因为 <code>libuv</code> 的 <a href="https://github.com/pnpm/pnpm/issues/2761" target="_blank" rel="noopener noreferrer">bug<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. 所以在 <code>copy-on-write</code> 不生效的情况下被回退到了 <code>hardlink</code> 的方式去处理.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/other/%E8%B7%A8%E7%AB%AF%E6%9D%82%E8%B0%88/" class="prev">
        跨端杂谈
      </a></span> <span class="next"><a href="/other/chromedevtool/">
        chrome devtools
      </a>
      →
    </span></p></div>  <!----></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b8096a98.js" defer></script><script src="/assets/js/21.bf7b29c4.js" defer></script><script src="/assets/js/2.f7c58a73.js" defer></script><script src="/assets/js/5.79fff311.js" defer></script>
  </body>
</html>
