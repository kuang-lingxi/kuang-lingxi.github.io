<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>setStateåˆ°åº•æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ | buuug</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Blog">
    
    <link rel="preload" href="/assets/css/0.styles.a509abab.css" as="style"><link rel="preload" href="/assets/js/app.b8096a98.js" as="script"><link rel="preload" href="/assets/js/21.bf7b29c4.js" as="script"><link rel="preload" href="/assets/js/2.f7c58a73.js" as="script"><link rel="preload" href="/assets/js/18.e006a18f.js" as="script"><link rel="prefetch" href="/assets/js/10.9f899a40.js"><link rel="prefetch" href="/assets/js/11.2d977f36.js"><link rel="prefetch" href="/assets/js/12.6a78c77b.js"><link rel="prefetch" href="/assets/js/13.fbdd2dbb.js"><link rel="prefetch" href="/assets/js/14.a0e94ab5.js"><link rel="prefetch" href="/assets/js/15.14696e5f.js"><link rel="prefetch" href="/assets/js/16.b4d7f12b.js"><link rel="prefetch" href="/assets/js/17.a1268fee.js"><link rel="prefetch" href="/assets/js/19.dc652960.js"><link rel="prefetch" href="/assets/js/20.6871ee84.js"><link rel="prefetch" href="/assets/js/22.2b187d4a.js"><link rel="prefetch" href="/assets/js/23.b378ab73.js"><link rel="prefetch" href="/assets/js/24.7f821dca.js"><link rel="prefetch" href="/assets/js/25.3094cca7.js"><link rel="prefetch" href="/assets/js/26.b63bfa1d.js"><link rel="prefetch" href="/assets/js/27.05317306.js"><link rel="prefetch" href="/assets/js/28.5df471f1.js"><link rel="prefetch" href="/assets/js/29.460f4c4f.js"><link rel="prefetch" href="/assets/js/3.f9c8446f.js"><link rel="prefetch" href="/assets/js/30.dad3cbd3.js"><link rel="prefetch" href="/assets/js/31.f23cdcc2.js"><link rel="prefetch" href="/assets/js/32.b5d5a2db.js"><link rel="prefetch" href="/assets/js/33.af894eae.js"><link rel="prefetch" href="/assets/js/4.0bce2d4a.js"><link rel="prefetch" href="/assets/js/5.79fff311.js"><link rel="prefetch" href="/assets/js/6.ff667613.js"><link rel="prefetch" href="/assets/js/7.a5829279.js"><link rel="prefetch" href="/assets/js/8.61c949c0.js"><link rel="prefetch" href="/assets/js/9.968eca4f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a509abab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">buuug</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ä¸“é¢˜åˆ—è¡¨" class="dropdown-title"><span class="title">ä¸“é¢˜åˆ—è¡¨</span> <span class="arrow down"></span></button> <button type="button" aria-label="ä¸“é¢˜åˆ—è¡¨" class="mobile-dropdown-title"><span class="title">ä¸“é¢˜åˆ—è¡¨</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link router-link-active">
  react
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">
  éšä¾¿å†™å†™
</a></li><li class="dropdown-item"><!----> <a href="/chromium/" class="nav-link">
  chromium
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ä¸“é¢˜åˆ—è¡¨" class="dropdown-title"><span class="title">ä¸“é¢˜åˆ—è¡¨</span> <span class="arrow down"></span></button> <button type="button" aria-label="ä¸“é¢˜åˆ—è¡¨" class="mobile-dropdown-title"><span class="title">ä¸“é¢˜åˆ—è¡¨</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link router-link-active">
  react
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">
  éšä¾¿å†™å†™
</a></li><li class="dropdown-item"><!----> <a href="/chromium/" class="nav-link">
  chromium
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/react/%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/" class="sidebar-link">reactæ¸²æŸ“æµç¨‹</a></li><li><a href="/react/componentDidMount/" class="sidebar-link">componentDidMount</a></li><li><a href="/react/diff/" class="sidebar-link">reactçš„diffç®—æ³•</a></li><li><a href="/react/hooks/" class="sidebar-link">react hooks</a></li><li><a href="/react/react17-setState/" aria-current="page" class="active sidebar-link">react17çš„setState</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react17-setState/#ç»“è®º" class="sidebar-link">ç»“è®º</a></li><li class="sidebar-sub-header"><a href="/react/react17-setState/#scheduleupdateonfiber" class="sidebar-link">scheduleUpdateOnFiber</a></li><li class="sidebar-sub-header"><a href="/react/react17-setState/#usestateçš„setstate" class="sidebar-link">useStateçš„setState</a></li><li class="sidebar-sub-header"><a href="/react/react17-setState/#æ¡ˆä¾‹åˆ†æ" class="sidebar-link">æ¡ˆä¾‹åˆ†æ</a></li></ul></li><li><a href="/react/react18-setState/" class="sidebar-link">react18çš„setState</a></li><li><a href="/react/useEffect/" class="sidebar-link">useEffectå’ŒuseLayoutEffect</a></li><li><a href="/react/react%20useState%E7%9A%84%E8%87%AA%E5%8A%A8%E4%BC%98%E5%8C%96/" class="sidebar-link">react useStateçš„è‡ªåŠ¨ä¼˜åŒ–</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="setstateåˆ°åº•æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥"><a href="#setstateåˆ°åº•æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥" class="header-anchor">#</a> setStateåˆ°åº•æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥</h1> <p><code>setState</code> åˆ°åº•æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥?å¾ˆå¤šäººå¯èƒ½éƒ½æœ‰è¿™ç§ç»å†, é¢è¯•çš„æ—¶å€™é¢è¯•å®˜ç»™äº†ä½ ä¸€æ®µä»£ç , è®©ä½ è¯´å‡ºè¾“å‡ºçš„å†…å®¹, æ¯”å¦‚è¿™æ ·:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'data'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'did mount state'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;did mount state &quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// did mount state data</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'setTimeout'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout &quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>è€Œè¿™æ®µä»£ç çš„è¾“å‡ºç»“æœ, ç¬¬ä¸€ä¸ª <code>console.log</code> ä¼šè¾“å‡º <code>data</code> , è€Œç¬¬äºŒä¸ª <code>console.log</code> ä¼šè¾“å‡º <code>setTimeout</code> .ä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡ <code>setState</code> çš„æ—¶å€™, å®ƒæ˜¯å¼‚æ­¥çš„, ç¬¬äºŒæ¬¡ <code>setState</code> çš„æ—¶å€™, å®ƒåˆå˜æˆäº†åŒæ­¥çš„.æ˜¯ä¸æ˜¯æœ‰ç‚¹æ™•?ä¸æ…Œ, æˆ‘ä»¬å»æºç ä¸­çœ‹çœ‹å®ƒåˆ°åº•å¹²äº†ä»€ä¹ˆ.</p> <h2 id="ç»“è®º"><a href="#ç»“è®º" class="header-anchor">#</a> ç»“è®º</h2> <p>å…ˆæŠŠç»“è®ºæ”¾åˆ°å‰é¢, æ‡’å¾—çœ‹çš„åŒå­¦å¯ä»¥ç›´æ¥çœ‹ç»“è®ºäº†.</p> <p>åªè¦ä½ è¿›å…¥äº† <code>react</code> çš„è°ƒåº¦æµç¨‹, é‚£å°±æ˜¯å¼‚æ­¥çš„.åªè¦ä½ æ²¡æœ‰è¿›å…¥ <code>react</code> çš„è°ƒåº¦æµç¨‹, é‚£å°±æ˜¯åŒæ­¥çš„.ä»€ä¹ˆä¸œè¥¿ä¸ä¼šè¿›å…¥ <code>react</code> çš„è°ƒåº¦æµç¨‹? <code>setTimeout</code> <code>setInterval</code>  , ç›´æ¥åœ¨ <code>DOM</code>  ä¸Šç»‘å®šåŸç”Ÿäº‹ä»¶ç­‰.è¿™äº›éƒ½ä¸ä¼šèµ° <code>React</code> çš„è°ƒåº¦æµç¨‹, ä½ åœ¨è¿™ç§æƒ…å†µä¸‹è°ƒç”¨ <code>setState</code> , é‚£è¿™æ¬¡ <code>setState</code> å°±æ˜¯åŒæ­¥çš„.
å¦åˆ™å°±æ˜¯å¼‚æ­¥çš„.</p> <p>è€Œ <code>setState</code> åŒæ­¥æ‰§è¡Œçš„æƒ…å†µä¸‹,  <code>DOM</code> ä¹Ÿä¼šè¢«åŒæ­¥æ›´æ–°, ä¹Ÿå°±æ„å‘³ç€å¦‚æœä½ å¤šæ¬¡ <code>setState</code> , ä¼šå¯¼è‡´å¤šæ¬¡æ›´æ–°, è¿™æ˜¯æ¯«æ— æ„ä¹‰å¹¶ä¸”æµªè´¹æ€§èƒ½çš„.</p> <h2 id="scheduleupdateonfiber"><a href="#scheduleupdateonfiber" class="header-anchor">#</a> scheduleUpdateOnFiber</h2> <p><code>setState</code> è¢«è°ƒç”¨åæœ€ç»ˆä¼šèµ°åˆ° <code>scheduleUpdateOnFiber</code> è¿™ä¸ªå‡½æ•°é‡Œé¢æ¥, æˆ‘ä»¬æ¥çœ‹çœ‹è¿™é‡Œé¢åˆåšäº†ä»€ä¹ˆ:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">warnAboutRenderPhaseUpdatesInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">markUpdateTimeFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warnAboutUpdateOnUnmountedFiberInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">checkForInterruption</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">recordScheduleUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TODO: computeExpirationForFiber also reads the priority. Pass the</span>
  <span class="token comment">// priority as an argument to that function and this one.</span>

  <span class="token keyword">var</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token comment">// Check if we're inside unbatchedUpdates</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span> <span class="token comment">// Check if we're not already rendering</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Register pending interactions on the root to avoid losing traced interaction data.</span>
      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span>
      <span class="token comment">// root inside of batchedUpdates should be synchronous, but layout updates</span>
      <span class="token comment">// should be deferred until the end of the batch.</span>

      <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

	  <span class="token comment">// é‡ç‚¹!!!!!!</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Flush the synchronous work now, unless we're already working or inside</span>
        <span class="token comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span>
        <span class="token comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span>
        <span class="token comment">// without immediately flushing it. We only do this for user-initiated</span>
        <span class="token comment">// updates, to preserve historical behavior of legacy mode.</span>
        <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> DiscreteEventContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token comment">// Only updates at user-blocking priority or greater are considered</span>
  <span class="token comment">// discrete, even inside a discrete event.</span>
  priorityLevel <span class="token operator">===</span> UserBlockingPriority$1 <span class="token operator">||</span> priorityLevel <span class="token operator">===</span> ImmediatePriority<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the result of a discrete event. Track the lowest priority</span>
    <span class="token comment">// discrete update per root so we can flush them early, if needed.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootsWithPendingDiscreteUpdates <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      rootsWithPendingDiscreteUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> lastDiscreteTime <span class="token operator">=</span> rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastDiscreteTime <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> lastDiscreteTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬ç€é‡çœ‹è¿™æ®µä»£ç :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Flush the synchronous work now, unless we're already working or inside</span>
  <span class="token comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span>
  <span class="token comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span>
  <span class="token comment">// without immediately flushing it. We only do this for user-initiated</span>
  <span class="token comment">// updates, to preserve historical behavior of legacy mode.</span>
  <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>executionContext</code> ä»£è¡¨äº†ç›®å‰ <code>react</code> æ‰€å¤„çš„é˜¶æ®µ, è€Œ <code>NoContext</code> ä½ å¯ä»¥ç†è§£ä¸ºæ˜¯ <code>react</code> å·²ç»æ²¡æ´»å¹²äº†çš„çŠ¶æ€.è€Œ <code>flushSyncCallbackQueue</code> é‡Œé¢å°±ä¼šå»åŒæ­¥è°ƒç”¨æˆ‘ä»¬çš„ <code>this.setState</code> , ä¹Ÿå°±æ˜¯è¯´ä¼šåŒæ­¥æ›´æ–°æˆ‘ä»¬çš„ <code>state</code> .æ‰€ä»¥, æˆ‘ä»¬çŸ¥é“äº†, å½“ <code>executionContext</code> ä¸º <code>NoContext</code> çš„æ—¶å€™, æˆ‘ä»¬çš„ <code>setState</code> å°±æ˜¯åŒæ­¥çš„.é‚£ä»€ä¹ˆåœ°æ–¹ä¼šæ”¹å˜ <code>executionContext</code> çš„å€¼å‘¢?</p> <p>æˆ‘ä»¬éšä¾¿æ‰¾å‡ ä¸ªåœ°æ–¹çœ‹çœ‹</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">batchedEventUpdates$1</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">|=</span> EventContext<span class="token punctuation">;</span>
  <span class="token operator">...</span>çœç•¥
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">batchedUpdates$1</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">|=</span> BatchedContext<span class="token punctuation">;</span>
  <span class="token operator">...</span>çœç•¥
<span class="token punctuation">}</span>
</code></pre></div><p>å½“ <code>react</code> è¿›å…¥å®ƒè‡ªå·±çš„è°ƒåº¦æ­¥éª¤æ—¶, ä¼šç»™è¿™ä¸ª <code>executionContext</code> èµ‹äºˆä¸åŒçš„å€¼, è¡¨ç¤ºä¸åŒçš„æ“ä½œä»¥åŠå½“å‰æ‰€å¤„çš„çŠ¶æ€, è€Œ <code>executionContext</code> çš„åˆå§‹å€¼å°±æ˜¯ <code>NoContext</code> , æ‰€ä»¥åªè¦ä½ ä¸è¿›å…¥ <code>react</code> çš„è°ƒåº¦æµç¨‹, è¿™ä¸ªå€¼å°±æ˜¯ <code>NoContext</code> , é‚£ä½ çš„ <code>setState</code> å°±æ˜¯åŒæ­¥çš„.</p> <h2 id="usestateçš„setstate"><a href="#usestateçš„setstate" class="header-anchor">#</a> useStateçš„setState</h2> <p>è‡ªä» <code>raect</code> å‡ºäº† <code>hooks</code> ä¹‹å, å‡½æ•°ç»„ä»¶ä¹Ÿèƒ½æœ‰è‡ªå·±çš„çŠ¶æ€, é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è°ƒç”¨å®ƒçš„ <code>setState</code> ä¹Ÿæ˜¯å’Œ <code>this.setState</code> ä¸€æ ·çš„æ•ˆæœå—?</p> <p>å¯¹, å› ä¸º <code>useState</code> çš„ <code>set</code> å‡½æ•°æœ€ç»ˆä¹Ÿä¼šèµ°åˆ° <code>scheduleUpdateOnFiber</code> , æ‰€ä»¥åœ¨è¿™ä¸€ç‚¹ä¸Šå’Œ <code>this.setState</code> æ˜¯æ²¡æœ‰åŒºåˆ«çš„.</p> <p>ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯, æˆ‘ä»¬è°ƒç”¨ <code>this.setState</code> çš„æ—¶å€™, å®ƒä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åšä¸€ä¸ª <code>state</code> çš„åˆå¹¶, è€Œ <code>hook</code> åˆ™ä¸ä¼š, æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™è¦ç€é‡æ³¨æ„è¿™ä¸€ç‚¹.</p> <p>ä¸¾ä¸ªğŸŒ°</p> <div class="language-js extra-class"><pre class="language-js"><code>state <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'data'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data1</span><span class="token operator">:</span> <span class="token string">'data1'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'new data'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//{ data: 'new data',data1: 'data1' }</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token literal-property property">data1</span><span class="token operator">:</span> <span class="token string">'data1'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'new data'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//{ data: 'new data' }</span>
</code></pre></div><p>ä½†æ˜¯å¦‚æœä½ è‡ªå·±å»å°è¯•åœ¨ <code>function</code> ç»„ä»¶çš„ <code>setTimeout</code> ä¸­å»è°ƒç”¨ <code>setState</code> ä¹‹å, æ‰“å° <code>state</code> , ä½ ä¼šå‘ç°ä»–å¹¶æ²¡æœ‰æ”¹å˜, è¿™æ—¶ä½ å°±ä¼šå¾ˆç–‘æƒ‘, ä¸ºä»€ä¹ˆå‘¢?è¿™ä¸æ˜¯åŒæ­¥æ‰§è¡Œçš„å—?</p> <p>è¿™æ˜¯å› ä¸ºä¸€ä¸ªé—­åŒ…é—®é¢˜, ä½ æ‹¿åˆ°çš„è¿˜æ˜¯ä¸Šä¸€ä¸ª <code>state</code> , é‚£æ‰“å°å‡ºæ¥çš„å€¼è‡ªç„¶æ˜¯ä¸Šä¸€æ¬¡çš„, æ­¤æ—¶çœŸæ­£çš„ <code>state</code> å·²ç»è¢«æ”¹å˜äº†.é‚£æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ³•å¯ä»¥è§‚å¯Ÿåˆ° <code>function</code> å‡½æ•°çš„åŒæ­¥è¡Œä¸º?æœ‰, æˆ‘ä»¬ä¸‹é¢å†ä»‹ç».</p> <h2 id="æ¡ˆä¾‹åˆ†æ"><a href="#æ¡ˆä¾‹åˆ†æ" class="header-anchor">#</a> æ¡ˆä¾‹åˆ†æ</h2> <p><code>setTimeout</code> ã€åŸç”Ÿäº‹ä»¶å†…è°ƒç”¨ <code>setState</code> çš„æ“ä½œç¡®å®æ¯”è¾ƒå°‘è§, ä½†æ˜¯ä¸‹é¢è¿™ç§å†™æ³•ä¸€å®šå¾ˆå¸¸è§äº†.</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'fetch data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;data: &quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// data: fetch data</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬åœ¨ <code>didMount</code> çš„æ—¶å€™å‘äº†ä¸€ä¸ªè¯·æ±‚, ç„¶åå†å°†ç»“æœ <code>setState</code> , è¿™æ—¶å€™æˆ‘ä»¬ç”¨äº† <code>async/await</code> æ¥è¿›è¡Œå¤„ç†.</p> <p>è¿™æ—¶å€™æˆ‘ä»¬ä¼šå‘ç°å…¶å® <code>setState</code> ä¹Ÿä¼šå˜æˆåŒæ­¥äº†, ä¸ºä»€ä¹ˆå‘¢?å› ä¸º<code>componentDidMount</code>æ‰§è¡Œå®Œæ¯•å, å°±å·²ç»é€€å‡ºäº† <code>react</code> çš„è°ƒåº¦, è€Œæˆ‘ä»¬è¯·æ±‚çš„ä»£ç è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•, ç­‰ç»“æœè¯·æ±‚å›æ¥ä»¥å <code>setState</code> æ‰ä¼šæ‰§è¡Œ.<code>async</code> å‡½æ•°ä¸­ <code>await</code> åé¢çš„ä»£ç å…¶å®æ˜¯å¼‚æ­¥æ‰§è¡Œçš„.è¿™å’Œæˆ‘ä»¬åœ¨ <code>setTimeout</code> ä¸­æ‰§è¡Œ <code>setState</code> å…¶å®æ˜¯ä¸€ä¸ªæ•ˆæœ, æ‰€ä»¥æˆ‘ä»¬çš„ <code>setState</code> å°±å˜æˆåŒæ­¥çš„äº†.</p> <p>å¦‚æœå®ƒå˜æˆåŒæ­¥ä¼šæœ‰ä»€ä¹ˆåå¤„å‘¢?æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚æœæˆ‘ä»¬å¤šæ¬¡è°ƒç”¨äº† <code>setState</code> ä¼šå‘ç”Ÿä»€ä¹ˆ.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'init data'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'data 1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// console.log(&quot;dom value&quot;, document.querySelector('#state').innerHTML);</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'data 2'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// console.log(&quot;dom value&quot;, document.querySelector('#state').innerHTML);</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'data 3'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// console.log(&quot;dom value&quot;, document.querySelector('#state').innerHTML);</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;state&quot;</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>data<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™æ˜¯åœ¨æµè§ˆå™¨è¿è¡Œçš„ç»“æœ</p> <img src="/assets/img/setState.380b4b29.gif"> <p>è¿™æ ·æ¥çœ‹çš„è¯, å…¶å®ä¹Ÿå¹¶æ²¡æœ‰ä»€ä¹ˆ, æ¯æ¬¡åˆ·æ–°åæœ€ç»ˆè¿˜æ˜¯ä¼šæ˜¾ç¤º <code>data 3</code> , ä½†æ˜¯æˆ‘ä»¬å°†ä»£ç ä¸­ <code>console.log</code> çš„æ³¨é‡Šå»æ‰, å†çœ‹çœ‹:</p> <img src="/assets/img/console.a2be629d.jpg"> <p>æˆ‘ä»¬æ¯æ¬¡éƒ½èƒ½åœ¨ <code>DOM</code> ä¸Šæ‹¿åˆ°æœ€æ–°çš„ <code>state</code> , è¿™æ˜¯å› ä¸º <code>react</code> å·²ç»æŠŠ <code>state</code> çš„ä¿®æ”¹åŒæ­¥æ›´æ–°äº†, ä½†æ˜¯ä¸ºä»€ä¹ˆç•Œé¢æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥?å› ä¸ºå¯¹æµè§ˆå™¨æ¥è¯´, æ¸²æŸ“çº¿ç¨‹ å’Œ jsçº¿ç¨‹ æ˜¯äº’æ–¥çš„,  <code>react</code> ä»£ç è¿è¡Œæ—¶æµè§ˆå™¨æ˜¯æ²¡åŠæ³•æ¸²æŸ“çš„.æ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬å·²ç»æŠŠ <code>DOM</code> æ›´æ–°äº†, ä½†æ˜¯ <code>state</code> åˆè¢«ä¿®æ”¹äº†,  <code>react</code> åªå¥½å†åšä¸€æ¬¡æ›´æ–°, è¿™æ ·åå¤äº†ä¸‰æ¬¡, æœ€å <code>react</code> ä»£ç æ‰§è¡Œå®Œæ¯•å, æµè§ˆå™¨æ‰æŠŠæœ€ç»ˆçš„ç»“æœæ¸²æŸ“åˆ°äº†ç•Œé¢ä¸Š.è¿™ä¹Ÿå°±æ„å‘³ç€å…¶å®æˆ‘ä»¬å·²ç»åšäº†ä¸¤æ¬¡æ— ç”¨çš„æ›´æ–°.</p> <p>æˆ‘ä»¬æŠŠ <code>setTimeout</code> å»æ‰, å°±ä¼šå‘ç°ä¸‰æ¬¡éƒ½è¾“å‡ºäº† <code>init data</code> , å› ä¸ºæ­¤æ—¶çš„ <code>setState</code> æ˜¯å¼‚æ­¥çš„, ä¼šæŠŠä¸‰æ¬¡æ›´æ–°åˆå¹¶åˆ°ä¸€æ¬¡å»æ‰§è¡Œ.</p> <p>æ‰€ä»¥å½“ <code>setState</code> å˜æˆåŒæ­¥çš„æ—¶å€™å°±è¦æ³¨æ„, ä¸è¦å†™å‡ºè®© <code>react</code> å¤šæ¬¡æ›´æ–°ç»„ä»¶çš„ä»£ç , è¿™æ˜¯æ¯«æ— æ„ä¹‰çš„.</p> <p>è€Œè¿™é‡Œä¹Ÿå›ç­”äº†ä¹‹å‰æå‡ºçš„é—®é¢˜, å¦‚æœæˆ‘ä»¬æƒ³åœ¨ <code>function</code> å‡½æ•°ä¸­è§‚å¯Ÿåˆ°åŒæ­¥æµç¨‹, å¤§å®¶å¯ä»¥å»è¯•è¯•å½“ä½ åœ¨ <code>setTimeout</code> ä¸­ <code>setState</code> ä¹‹å,  <code>DOM</code> é‡Œé¢çš„å†…å®¹ä¼šä¸ä¼šæ”¹å˜.</p> <h3 id="ç»“è¯­"><a href="#ç»“è¯­" class="header-anchor">#</a> ç»“è¯­</h3> <p><code>react</code> å·²ç»å¸®åŠ©æˆ‘ä»¬åšäº†å¾ˆå¤šä¼˜åŒ–æªæ–½, ä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿä¼šå› ä¸ºä»£ç ä¸åŒçš„å®ç°æ–¹å¼è€Œå¯¼è‡´ <code>react</code> çš„æ€§èƒ½ä¼˜åŒ–å¤±æ•ˆ, ç›¸å½“äºæˆ‘ä»¬è‡ªå·±åšäº†åä¼˜åŒ–.æ‰€ä»¥ç†è§£ <code>react</code> çš„è¿è¡ŒåŸç†å¯¹æˆ‘ä»¬æ—¥å¸¸å¼€å‘ç¡®å®æ˜¯å¾ˆæœ‰å¸®åŠ©çš„.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/react/hooks/" class="prev">
        react hooks
      </a></span> <span class="next"><a href="/react/react18-setState/">
        react18çš„setState
      </a>
      â†’
    </span></p></div>  <!----></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b8096a98.js" defer></script><script src="/assets/js/21.bf7b29c4.js" defer></script><script src="/assets/js/2.f7c58a73.js" defer></script><script src="/assets/js/18.e006a18f.js" defer></script>
  </body>
</html>
