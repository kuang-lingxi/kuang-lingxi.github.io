<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解vue响应式原理 | buuug</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Blog">
    
    <link rel="preload" href="/assets/css/0.styles.a509abab.css" as="style"><link rel="preload" href="/assets/js/app.b8096a98.js" as="script"><link rel="preload" href="/assets/js/21.bf7b29c4.js" as="script"><link rel="preload" href="/assets/js/2.f7c58a73.js" as="script"><link rel="preload" href="/assets/js/19.dc652960.js" as="script"><link rel="prefetch" href="/assets/js/10.9f899a40.js"><link rel="prefetch" href="/assets/js/11.2d977f36.js"><link rel="prefetch" href="/assets/js/12.6a78c77b.js"><link rel="prefetch" href="/assets/js/13.fbdd2dbb.js"><link rel="prefetch" href="/assets/js/14.a0e94ab5.js"><link rel="prefetch" href="/assets/js/15.14696e5f.js"><link rel="prefetch" href="/assets/js/16.b4d7f12b.js"><link rel="prefetch" href="/assets/js/17.a1268fee.js"><link rel="prefetch" href="/assets/js/18.e006a18f.js"><link rel="prefetch" href="/assets/js/20.6871ee84.js"><link rel="prefetch" href="/assets/js/22.2b187d4a.js"><link rel="prefetch" href="/assets/js/23.b378ab73.js"><link rel="prefetch" href="/assets/js/24.7f821dca.js"><link rel="prefetch" href="/assets/js/25.3094cca7.js"><link rel="prefetch" href="/assets/js/26.b63bfa1d.js"><link rel="prefetch" href="/assets/js/27.05317306.js"><link rel="prefetch" href="/assets/js/28.5df471f1.js"><link rel="prefetch" href="/assets/js/29.460f4c4f.js"><link rel="prefetch" href="/assets/js/3.f9c8446f.js"><link rel="prefetch" href="/assets/js/30.dad3cbd3.js"><link rel="prefetch" href="/assets/js/31.f23cdcc2.js"><link rel="prefetch" href="/assets/js/32.b5d5a2db.js"><link rel="prefetch" href="/assets/js/33.af894eae.js"><link rel="prefetch" href="/assets/js/4.0bce2d4a.js"><link rel="prefetch" href="/assets/js/5.79fff311.js"><link rel="prefetch" href="/assets/js/6.ff667613.js"><link rel="prefetch" href="/assets/js/7.a5829279.js"><link rel="prefetch" href="/assets/js/8.61c949c0.js"><link rel="prefetch" href="/assets/js/9.968eca4f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a509abab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">buuug</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题列表" class="dropdown-title"><span class="title">专题列表</span> <span class="arrow down"></span></button> <button type="button" aria-label="专题列表" class="mobile-dropdown-title"><span class="title">专题列表</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link router-link-active">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">
  随便写写
</a></li><li class="dropdown-item"><!----> <a href="/chromium/" class="nav-link">
  chromium
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题列表" class="dropdown-title"><span class="title">专题列表</span> <span class="arrow down"></span></button> <button type="button" aria-label="专题列表" class="mobile-dropdown-title"><span class="title">专题列表</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link router-link-active">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">
  随便写写
</a></li><li class="dropdown-item"><!----> <a href="/chromium/" class="nav-link">
  chromium
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vue/vue%E5%B7%A5%E7%A8%8B%E5%8C%96/" class="sidebar-link">vue工程化</a></li><li><a href="/vue/reactivity/" aria-current="page" class="active sidebar-link">深入理解vue响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue/reactivity/#写在前面" class="sidebar-link">写在前面</a></li><li class="sidebar-sub-header"><a href="/vue/reactivity/#响应式基础-api" class="sidebar-link">响应式基础 API</a></li><li class="sidebar-sub-header"><a href="/vue/reactivity/#refs" class="sidebar-link">Refs</a></li><li class="sidebar-sub-header"><a href="/vue/reactivity/#computed-与-watch" class="sidebar-link">Computed 与 watch</a></li><li class="sidebar-sub-header"><a href="/vue/reactivity/#结语" class="sidebar-link">结语</a></li><li class="sidebar-sub-header"><a href="/vue/reactivity/#参考资料" class="sidebar-link">参考资料</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="深入理解vue响应式原理"><a href="#深入理解vue响应式原理" class="header-anchor">#</a> 深入理解vue响应式原理</h1> <h2 id="写在前面"><a href="#写在前面" class="header-anchor">#</a> 写在前面</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>一切黑魔法的背后都是1+1</p></div> <p>众所周知, 目前每个前端开发都会接触过一到两个框架. 或许是 <code>react</code>, 或许是 <code>vue</code>, 又或许是 <code>angular</code>.我们在使用这些框架的同时又有没有想过, 在这些看似很魔幻的功能背后到底隐藏着什么东西, 它又是如何运作的? 今天我们就针对 <code>vue</code> 最核心的响应式原理做一次深入的剖析.</p> <p>那么什么是响应式呢? 我们知道在 <code>react</code> 中, 如果你想更新你的视图, 那么你需要在改变状态之后手动去调用 <code>react</code> 提供的 <code>setState</code> 方法. 而在 <code>vue</code> 里面, 我们修改 <code>data</code> 之后并不需要我们手动去调用什么方法通知 <code>vue</code> 去更新视图, 因为 <code>vue</code> 能够感知到某个状态被改变了, 从而主动的去更新视图, 对于开发者而言, 这可能更能让人接受, 而主动感知并更新视图的这个过程, 其实就是<strong>响应式</strong>.</p> <p>继续用大白话来解释就是下面这个过程:</p> <ol><li><p><code>vue</code> 在初始化的过程中会对某些特定的数据进行劫持. 什么叫做劫持呢, 就是你对这个数据的任何读取, 赋值操作都会经过 <code>vue</code> 才能成功. 例如我们声明的 <code>data</code>, 当我们读取 <code>data</code> 里面的数据时, 必须经过 <code>vue</code>, 然后 <code>vue</code> 再给我们返回想要的数据, 去给 <code>data</code> 里面的数据赋值时, 也需要经过 <code>vue</code>, 让 <code>vue</code> 去帮助我们赋值. 整个劫持操作在 <code>vue3</code> 里面通过 <code>Proxy</code> 去实现, 我们后面会介绍到它, 现在大家只需要知道 <code>vue</code> 会这么干就行了.</p></li> <li><p>那我们什么时候需要更新数据? 我们在 <code>template</code> 里面用到数据的时候, 一定会去读取 <code>data</code> 里面的值, 这个时候这个信息就被 <code>vue</code> 捕获到了, 同时, 这时候 <code>vue</code> 还能知道你是在哪个 <code>template</code> 里面用的这个值, 并将其一并记录下来.</p></li> <li><p>当我们去改变 <code>data</code> 里面的值时, <code>vue</code> 又知道了, 同时他还记录了这个值对应的 <code>template</code>, 所以自然就会去主动更新你的视图, 完成整个更新流程.</p></li></ol> <p>例如下面这段代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>msg<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">&quot;change&quot;</span><span class="token operator">&gt;</span>change<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>template<span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello world'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">'hello world!!!!'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>当这段代码被解析并初次渲染时, <code>vue</code> 会经过下面这几步:</p> <img src="data:image/png;base64,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"> <p>当我们更新 <code>data</code> 的时候, 是下面的流程:</p> <img src="/assets/img/update.3421ec84.png"> <p>这就是 <code>vue</code> 的响应式过程. <code>vue3.0</code> 已经把响应式相关的函数都抽到了 <code>@vue/reactivity</code> 中, <a href="https://v3.cn.vuejs.org/api/reactivity-api.html" target="_blank" rel="noopener noreferrer">官网文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>在此. <code>vue</code> 里面所有和响应式相关的操作都通过这些函数来完成, 下面我们将顺着官网的介绍, 一个个对他们进行更加详细的介绍, 大家可以将该文档作为官网的补充文档进行阅读. 同时也推荐大家对于 <code>vue3</code> 的 <code>Reactivity API</code> 有一定了解之后再来看这篇文章, 收获会更多.</p> <h2 id="响应式基础-api"><a href="#响应式基础-api" class="header-anchor">#</a> 响应式基础 API</h2> <h3 id="reactive"><a href="#reactive" class="header-anchor">#</a> reactive</h3> <p>该方法就是返回一个对象的响应式副本, 他的响应式转换是深层的——它影响所有嵌套 <code>property</code>.在基于 <code>ES2015 Proxy</code> 的实现中, 返回的 <code>proxy</code> 是不等于原始对象的.</p> <p>这个就是我们之前所说的 <code>vue</code> 劫持 <code>data</code> 的方法. 它的内部是通过 <code>Proxy</code> 实现的, 具体用法可以参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="noopener noreferrer">MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. 在这里我们可以简单写一个<code>demo</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'klx'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;get: &quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;set: &quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxyObj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token comment">// set:  { name: 'klx' } name hello world { name: 'klx' }</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyObj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// get:  { name: 'hello world' } name { name: 'hello world' }</span>
<span class="token comment">// hello world</span>
</code></pre></div><p>通过传递 <code>get</code>、<code>set</code> 方法给 <code>Proxy</code>, 我们就能劫持到 <code>obj</code> 对象的读取和赋值操作, 进而能够在这些阶段做一些我们想做的事情.</p> <p>我们可以看到这里面还使用了一个 <code>Reflect</code>, 这又是个啥玩意? 我们还是来看看<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect" target="_blank" rel="noopener noreferrer">MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. 在 <code>proxy</code> 中使用它来操作 <code>target</code> 主要是为了获取正确的上下文引用. 举个例子:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">_name</span><span class="token operator">:</span> <span class="token string">&quot;parent name&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> parentProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 正确写法</span>
    <span class="token comment">//return Reflect.get(target, prop, receiver);</span>

    <span class="token comment">// 错误写法</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">_name</span><span class="token operator">:</span> <span class="token string">&quot;child name&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> parentProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// parent name</span>
<span class="token comment">// 想要拿到 child name, 当时却拿到了 parent name</span>
</code></pre></div><p>在这个例子中, 我们的本意是想拿到 <code>child name</code>, 但是最后却拿到了 <code>parent name</code>, 这是因为 <code>this</code> 对象指向了 <code>parent</code>, 但是我们调用的时候明明是 <code>child</code>. 这个时候就出现了 <code>this</code> 指向错误的问题, 好在 <code>Reflect.get</code> 方法接受一个 <code>receiver</code> 参数用来修改 <code>getter</code> 调用时候的 <code>this</code> 指向, 所以这样我们才能拿到我们真正想要的值.</p> <p>除此之外, 还有几个问题需要大家注意一下:</p> <p><strong>1. proxy 只能代理对象</strong></p> <p><code>Proxy</code> 能够代理的对象仅限于 <code>Object</code>(<code>Array</code>, <code>Map</code>, <code>Set</code>, <code>WeakMap</code>, <code>WeakMap</code>等), 所以对于 <code>Number</code>、<code>String</code> 等类型, 它就无能为力了. 比如下面这段代码就会报错:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TypeError: Cannot create proxy with a non-object as target or handler</span>
</code></pre></div><p>而我们在使用 <code>vue</code> 的过程中肯定会出现一些非对象类型, 那么这个时候会怎么处理? 凭直觉来说, 肯定是再做一层包装, 将其包装成对象再进行代理. 实际上 <code>vue</code> 也是这么干的, 这一块内容我们会在介绍<code>Ref</code>的时候提到.</p> <p><strong>2. 解构会使该 <code>proxy</code> 失去响应性</strong></p> <p>我们看这个例子:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'klx'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token comment">// get { name: 'klx' } name</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token comment">// get { name: 'klx' } name</span>

name
<span class="token comment">// nothing</span>
</code></pre></div><p>现在我们再使用 <code>name</code> 是不会触发 <code>get</code> 函数的. 当然, 如果 <code>name</code> 本身就是一个具有响应性的对象, 那么它本身仍然具有响应性, 但是读取 <code>name</code> 的时候不会触发初始对象的响应性. 比如下面这个例子:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'klx'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;message get: &quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">proxyObj</span><span class="token operator">:</span> message<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;obj get: &quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>proxyObj<span class="token punctuation">;</span>
<span class="token comment">// obj get:  { proxyObj: { name: 'klx' } } proxyObj</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> proxyObj <span class="token punctuation">}</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token comment">// obj get:  { proxyObj: { name: 'klx' } } proxyObj</span>

proxyObj<span class="token punctuation">;</span>
<span class="token comment">// nothing</span>

proxyObj<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token comment">// message get:  { name: 'klx' } name</span>
</code></pre></div><p>我们把 <code>proxyObj</code> 对象解构出来之后, 读取它本身的<code>name</code>属性仍然会触发它自己的 <code>get</code> 函数, 但是我们再读取 <code>proxyObj</code> 的时候已经无法触发 <code>obj</code> 对象的 <code>get</code> 函数了.</p> <p><strong>3. proxy 本身不会进行递归代理</strong></p> <p>这句话是什么意思呢, 也就是说如果我们有一个对象, 它只会进行一层浅代理, 并不会继续对对象中的对象进行代理, 正如我们上一个例子中, 如果想让 <code>proxyObj</code> 也是一个代理的话, 那么我们需要进行额外的操作, 也就是传给<code>proxyObj</code>的对象就是一个 <code>proxy</code> 对象.</p> <p>而从官网的介绍我们明显可以看到, <code>reactive</code> 是会对进行一个深层次的转换, 具体怎么实现也非常简单.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就能保证对 <code>obj</code> 里面所有的对象都进行代理.</p> <p>至此, 对于这个 <code>api</code> 我们就介绍的差不多了, 可以看到我们大部分的篇幅都在介绍 <code>proxy</code>, 因为 <code>reactive</code> 其实就是 <code>proxy</code>, 所以现在我们知道, 通过这个<code>api</code>返回后的对象就是一个经过了 <code>proxy</code> 代理的对象.</p> <h3 id="effect"><a href="#effect" class="header-anchor">#</a> effect</h3> <p>接受一个传入的函数, 并响应式追踪其依赖, 在依赖发生变更的时候会重新运行该函数. 官网上并没有提及这个函数, 因为这是比较底层的一个函数, 我们日常使用可以用<code>watchEffect</code>来代替, 我们后面在说<code>watch</code>、<code>computed</code>的时候会提到.</p> <p>单独使用一个<code>reactive</code>其实并没有什么意义, 因为拿到这个<code>proxy</code>对象之后, 我们并不能干什么, 重要的是在<code>proxy</code>的<code>set</code>/<code>get</code>函数内部它干了什么. 我们在之前的介绍中说到, <code>vue</code> 获取到读取<code>data</code>的事件时, 会将<code>data.msg</code>和模版进行绑定, 这个过程其实就是在<code>get</code>中做的. 而这个模版其实就可以理解为传给<code>effect</code>的函数. 话不多说, 我们先来一个简单的例子看看:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> effect<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token operator">=</span> Vue<span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello world'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 首次运行会输出 hello world</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">'hello world!!!'</span>
  <span class="token comment">// obj的值发生改变之后会触发 effect 的函数再次运行, 再次输出 hello world!!!</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到, 首次运行输出了<code>hello world</code>, 当我们改变<code>obj.msg</code>的时候, 再次触发了该函数, 输出了<code>hello world!!!</code>. 所以这是不是和<code>data.msg</code>的值改变之后, <code>vue</code>能够重新更新视图很像? 那么这个 <code>effect</code> 函数是如何实现的呢? 我们可以将其拆分一下, 当我们做到下面这几个步骤的时候, 就能实现这个<code>effect</code>了.</p> <ol><li>获取到某个响应式数据被读取了</li> <li>知道此时这个响应式数据和什么东西要进行绑定</li> <li>响应式数据在发生某些更改的时候重新触发绑定的函数</li></ol> <p>那么在这里第一步我们已经知道怎么做了, 我们在<code>get</code>函数中就能知道某个响应式数据被改变了. 我们如何知道此时应该将它和什么东西绑定在一起? 其实在这里我们要做的就是要将其和传给<code>effect</code>的函数绑定在一起. 我们将这个函数称为副作用, 也就是某个值修改后应该运行的副作用函数. 我们可以用一个<code>activeEffect</code>来记录下当前的副作用函数, 这样在触发<code>get</code>的时候我们就能知道该和什么东西绑定了, 下面我们简单实现一下<code>effect</code>函数.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> effectMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeEffect <span class="token operator">=</span> f<span class="token punctuation">;</span>
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 收集副作用, 以 obj 为对象</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 副作用属于该对象的哪个属性</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果当前有活跃的副作用, 将其收集起来</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 触发副作用</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发哪个 key 的副作用</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 运行 key 里面的副作用</span>
  dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello world'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect1&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// effect1 hello world</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect2&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// effect2 hello world</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">'hello world!!!!'</span>
<span class="token comment">// effect1 hello world!!!!</span>
<span class="token comment">// effect2 hello world!!!!</span>
</code></pre></div><p>注意, 我们在<code>get</code>和<code>set</code>中干了什么呢, 我们维护了这样的一个列表:</p> <p>+---------------------------+<br>
|                           |<br>
|  target -&gt; key -&gt; effects |<br>
|                           |<br>
+---------------------------+</p> <p>当触发了<code>get</code>函数的时候我们就能知道这个<code>key</code>和什么副作用挂钩, 当前活跃的副作用是在<code>effect</code>内部去赋值的.</p> <p>当某个数据的<code>set</code>函数被触发的时候, 我们就能通过<code>target</code>和<code>key</code>找到应该触发的副作用, 再依次运行就好了.</p> <p>但是值得注意的是这样的实现只是一个简单的<code>demo</code>, 有很多东西都没有考虑到, 比如我们不能简单的通过<code>key</code>来对应这个列表, 因为对于<code>Array</code>、<code>Map</code>这些对象来说, <code>key</code>并不难一一对应. 比如说我在<code>effect</code>里面读取了一个<code>arr[2]</code>, 然后我运行了<code>arr.clear()</code>, 此时有可能并没有<code>2</code>的<code>key</code>, 但是显然此时应该触发副作用. 所以在<code>vue</code>真正实现中, 有两个对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TrackOpTypes <span class="token punctuation">{</span>
  <span class="token constant">GET</span> <span class="token operator">=</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token constant">HAS</span> <span class="token operator">=</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token constant">ITERATE</span> <span class="token operator">=</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TriggerOpTypes <span class="token punctuation">{</span>
  <span class="token constant">SET</span> <span class="token operator">=</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token constant">ADD</span> <span class="token operator">=</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token constant">DELETE</span> <span class="token operator">=</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token constant">CLEAR</span> <span class="token operator">=</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中<code>TrackOpTypes</code>标示在使用数据的时候可能触发的操作, <code>TriggerOpTypes</code>标示在修改数据时可能触发的操作, <code>vue</code>的内部实现会根据 <code>key</code>+<code>type</code> 来进行匹配, 判断执行相应的副作用.</p> <p>实际上是这样的映射关系:</p> <p>+--------------------------------------+<br>
|                                      |<br>
|  target -&gt; OpTypes + key -&gt; effects  |<br>
|                                      |<br>
+--------------------------------------+</p> <p>具体的逻辑大家可以参看源码, 但是我们只要知道有一个这样的映射关系就行了. 同时, 在生产环境中, 还需要考虑递归、调度的问题, 这里我们就不过多展开了, 有兴趣的同学可以和我私聊或者自己参看源码.</p> <p>这样, 我们就实现了一个简单的<code>effect</code>函数, 在我们改变某个响应式数据的时候, 能够触发对应的副作用函数. 实际上我们可以看到最核心的就是<code>track</code>和<code>trigger</code>函数(这两个函数非常重要, 后面会一直提到), <code>vue</code>把他们封装在了<code>reactive</code>内部, 我们是无感知的调用, 那么如果我们不使用响应式对象, 直接手动触发这两个函数能否触发<code>effect</code>的副作用函数呢?话不多说, 我们直接来实战演练一下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script setup<span class="token operator">&gt;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> effect<span class="token punctuation">,</span> trigger<span class="token punctuation">,</span> track <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@vue/reactivity&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> TrackOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">GET</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">HAS</span><span class="token operator">:</span> <span class="token string">&quot;has&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">ITERATE</span><span class="token operator">:</span> <span class="token string">&quot;iterate&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> TriggerOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">SET</span><span class="token operator">:</span> <span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">ADD</span><span class="token operator">:</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">CLEAR</span><span class="token operator">:</span> <span class="token string">&quot;clear&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 触发trigger函数, 用 type + key 找副作用</span>
  <span class="token keyword">const</span> <span class="token function-variable function">triggerEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">trigger</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;hello world&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 捕获当前副作用函数, 用 type + key 映射</span>
    <span class="token function">track</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  obj<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">&quot;hello world!!!!!&quot;</span><span class="token punctuation">;</span>
  <span class="token function">triggerEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">&quot;triggerEvent&quot;</span><span class="token operator">&gt;</span>
    点我触发副作用
  <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p><a href="https://play.vueuse.org/#N4IgDghgxg1hDmBTAziAXAbVAOwgW0XRADcBXRAWgBNE8BLEAGhGQHtSAnKQtEU7MDHhMQNZFA50wAFzqtsRAGrkABABFadFQAoAFhAA2AMxV1sKgGIdE2KLoCUp5CogqaxRAdZgz8FaVkDOmkATxcDLwB3ZxD2FWlWFUjJaUQVAFVsOg8OZEMVZTSAGToAIw4ISRQVI1YOAtUAJhUAMhUAZhFOAyJdaWkwZDQAemH+QXgAOihWPGGyShp6YaDS4bMaAA9JvAArVABfRhx8HhAAAQXSZERh5H1rKhE2Tm4icaERMQkpWXkiADKD0QVAaiHSN38gWCdBQky6HB6vD6AyGow+Uxmc0u5Gut3ulRB5wArJMAAyTACM62wW0mKDwk32ICOJwIRBxiDxwxm1me7C4ZwxXxQPxkcgUvAAwqwIogoH9zKwTCgbthZPlCioZXgwKxkDD5BlobIUAikSAUYMRmMBEJprNhpzubzECTyVSaXSGUzDscQLh2bxOcNrNBZMRgiFzb1+tbRlAqNhJsgYCFILBJu4nQtQ4hw9koyLxJJxf9g7mwwrC6ERDkDeWQEUIKlkNJ+a8zqn09AYCyALrMIx0AxmtCgACCYDAkwW6FAqV1BhbZwAPKUAglzOcoEFYABeAA6IGkkngSA4AFEPOrjwA+QCdDoBEI0AZ5GAReVAPZKgB15QAUrqvhhu-TyHezxiu2vB0LqdTSCowAqIgRhGPK0iMPEZ4Xqhp69ioBw1BwswqMeIZVhGUbHgA3Ie2BUTM2BtioAAqFSwAA8mADHptU+6wVRKgqAA4peDFoIRIBINIx6MLxKgABITgCInHvoyCSdJACSDGXgAShOmmKSAwSIBUqSqdgByUdRtjyPRTF0OeRlsRxYBcTx5gqACQn6TcElMNJE5qGo+kQFQVCmXxaiXkUQmXvpNCjiZvluVKUUTlp+m7vmHCmeZVFUaMKjvqedkXoAv4qAA6mqE-vEnEqAA1CoMCIGEgB+Rt+P40dZMFFfZV43jB3HaI4+53mhxVGdorClLsqG2T1jmccgkweQxqHHngyDwMe9gWR1dEwZNuwqNxcHrfA+m6J4XhJHUBihSAOE7dgCFIQq2iDUdI3ANJ+WAKrGgDtwYAyvqALJKbXlZV1XOXVDVNSogAEZoAIDrSVhsATVNM3MTA83OYtgkraJp1bRZfGGEZ0io7sOwbfYVEHNtuXYAdlN+NxSmXYkkQ3VQACEPM8xRVHdRe142GT20sswMp1FQZgrrO5DzietBgMuqREKu0vENJtTqkeIB4PIrDHtJpTwLrQTwH0FDEmSZJuJUMBoFQ9tWzbRtuUYo6bLrAB+KgzAYbt8akmzSLr3DqkZgcqGAuuNFHpRS0Zuv4fwNB3VRd7SauyCQOYweh8eAAsmwByAd7AHBxCGKoBwHP+OcQNgmdudnufxIgIe68geB2xwDvm5bACcNu9w73jQFGLvHioeC69IFBx2XACy7CQhXKjLqUng4XXdy583-4ayBzAlr8RCQXqHAwXBNDDk9AAK+GDDheEEQA5Asb-07fZiII-3jIG0F9Nym9PAiQBEVbA8ApJuSrgYcgIkABypA8Bbw4DA2mLJa5AA" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>在此.</p> <p>可以看到, 我们根本没有使用响应式对象, 但是也能触发副作用. 这就是因为响应式对象的内部其实也是通过<code>track</code>和<code>trigger</code>来触发, 我们只是把这个工作给提到外面来进行了而已.</p> <h3 id="readonly"><a href="#readonly" class="header-anchor">#</a> readonly</h3> <p>接受一个对象 (响应式或纯对象) 或 ref 并返回原始对象的只读代理.只读代理是深层的: 任何被访问的嵌套<code>property</code>也是只读的.</p> <p>一个只读的对象, 那不就是一个只有 <code>get</code> 的代理吗? 所以我们内部只要这样处理一下就好了:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> res<span class="token punctuation">;</span>      
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Set operation on key &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; failed: target is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        target
      <span class="token punctuation">)</span>

      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样, 当我们调用 <code>set</code> 方法的时候, 就会抛出一个错误提示用户这是一个只读属性.</p> <h3 id="isreadonly"><a href="#isreadonly" class="header-anchor">#</a> isReadonly</h3> <p>检查对象是否是由<code>readonly</code>创建的只读代理.</p> <p>这个函数的用法很简单明了, 我也不用过多介绍什么了. 那么具体如何实现这个函数呢, 我最直观的想法就是在使用<code>readonly</code>函数的时候在目标对象上挂一个属性用来标识这是一个<code>readonly</code>对象, <code>vue</code> 内部并没有这么做. 在内部实现中, 有一个<code>enum</code>表示标示了各种类型</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlags <span class="token punctuation">{</span>
  <span class="token constant">SKIP</span> <span class="token operator">=</span> <span class="token string">'__v_skip'</span><span class="token punctuation">,</span>
  <span class="token constant">IS_REACTIVE</span> <span class="token operator">=</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>
  <span class="token constant">IS_READONLY</span> <span class="token operator">=</span> <span class="token string">'__v_isReadonly'</span><span class="token punctuation">,</span>
  <span class="token constant">IS_SHALLOW</span> <span class="token operator">=</span> <span class="token string">'__v_isShallow'</span><span class="token punctuation">,</span>
  <span class="token constant">RAW</span> <span class="token operator">=</span> <span class="token string">'__v_raw'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中<code>IS_READONLY</code>就表示只读类型, 那么怎么用呢. 不管是在用<code>reactive</code>还是<code>readonly</code>创建副本的时候, <code>get</code>函数中都会有一个这样的操作:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当我们用<code>ReactiveFlags.IS_READONLY</code>的<code>key</code>去访问<code>object</code>的时候, 会返回<code>true</code>或者<code>false</code>表示这是一个什么变量, 那么很显然这两个函数中有很多重合的部分, 我们可以优化一下写成下面这样:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isReadonly<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么<code>readonly</code>的实现就非常简单了:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以直接实际演练一下, 不使用<code>isReadonly</code>函数, 直接使用<code>ReactiveFlags</code>来获取相应的值:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script setup<span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> readonly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
  
<span class="token keyword">const</span> ReactiveFlags <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">SKIP</span><span class="token operator">:</span> <span class="token string">'__v_skip'</span><span class="token punctuation">,</span>
  <span class="token constant">IS_REACTIVE</span><span class="token operator">:</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>
  <span class="token constant">IS_READONLY</span><span class="token operator">:</span> <span class="token string">'__v_isReadonly'</span><span class="token punctuation">,</span>
  <span class="token constant">IS_SHALLOW</span><span class="token operator">:</span> <span class="token string">'__v_isShallow'</span><span class="token punctuation">,</span>
  <span class="token constant">RAW</span><span class="token operator">:</span> <span class="token string">'__v_raw'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello world'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token keyword">const</span> isReadonly <span class="token operator">=</span> msg<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token literal-property property">isReadonly</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>isReadonly<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p>这里<code>isReadonly</code>会返回一个<code>true</code>, 也可以直接点击<a href="https://sfc.vuejs.org/#eyJBcHAudnVlIjoiPHNjcmlwdCBzZXR1cD5cbmltcG9ydCB7IHJlYWRvbmx5IH0gZnJvbSAndnVlJztcbiAgXG5jb25zdCBSZWFjdGl2ZUZsYWdzID0ge1xuICBTS0lQOiAnX192X3NraXAnLFxuICBJU19SRUFDVElWRTogJ19fdl9pc1JlYWN0aXZlJyxcbiAgSVNfUkVBRE9OTFk6ICdfX3ZfaXNSZWFkb25seScsXG4gIElTX1NIQUxMT1c6ICdfX3ZfaXNTaGFsbG93JyxcbiAgUkFXOiAnX192X3Jhdydcbn1cblxuY29uc3QgbXNnID0gcmVhZG9ubHkoe21zZzogJ2hlbGxvIHdvcmxkJ30pO1xuICBcbmNvbnN0IGlzUmVhZG9ubHkgPSBtc2dbUmVhY3RpdmVGbGFncy5JU19SRUFET05MWV07XG48L3NjcmlwdD5cblxuPHRlbXBsYXRlPlxuICA8ZGl2PlxuICAgIGlzUmVhZG9ubHk6IHt7aXNSZWFkb25seX19XG4gIDwvZGl2PlxuPC90ZW1wbGF0ZT4iLCJpbXBvcnQtbWFwLmpzb24iOiJ7XG4gIFwiaW1wb3J0c1wiOiB7XG4gICAgXCJ2dWVcIjogXCJodHRwczovL3NmYy52dWVqcy5vcmcvdnVlLnJ1bnRpbWUuZXNtLWJyb3dzZXIuanNcIlxuICB9XG59In0=" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>自己尝试一下.</p> <h3 id="toraw"><a href="#toraw" class="header-anchor">#</a> toRaw</h3> <p>返回<code>reactive</code>或<code>readonly</code>代理的原始对象.这是一个“逃生舱”, 可用于临时读取数据而无需承担代理访问/跟踪的开销, 也可用于写入数据而避免触发更改.不建议保留对原始对象的持久引用.请谨慎使用.</p> <p>我们可以看到之前的<code>Flags</code>里面有一个值就是<code>RAW</code>, 而我们在<code>get</code>函数中拿到的<code>target</code>其实就是原始对象, 所以怎么做大家也非常清楚了:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isReadonly<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="isreactive"><a href="#isreactive" class="header-anchor">#</a> isReactive</h3> <p>检查对象是否是由<code>reactive</code>创建的响应式代理. 如果该代理是<code>readonly</code>创建的, 但包裹了由<code>reactive</code>创建的另一个代理, 它也会返回<code>true</code>. 同样的, 它的实现也非常简单.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> obj<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="isproxy"><a href="#isproxy" class="header-anchor">#</a> isProxy</h3> <p>检查对象是否是由<code>reactive</code>或<code>readonly</code>创建的 proxy.</p> <p>我们之前已经介绍过了<code>isReactive</code>和<code>isReadonly</code>, 那么显然:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isProxy</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="markraw"><a href="#markraw" class="header-anchor">#</a> markRaw</h3> <p>标记一个对象, 使其永远不会转换为<code>proxy</code>.返回对象本身.</p> <p>在之前的<code>FLAGS</code>中有一个属性叫<code>SKIP</code>, 这个属性就是标示某个对象跳过代理. 所以我们只需要为对象加上这个属性就行了.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markRaw</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么很显然, 我们可以直接试试不使用markRaw方法, 直接给对象加一个<code>skip</code>属性会怎么样:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script setup<span class="token operator">&gt;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> isProxy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> ReactiveFlags <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">SKIP</span><span class="token operator">:</span> <span class="token string">'__v_skip'</span><span class="token punctuation">,</span>
    <span class="token constant">IS_REACTIVE</span><span class="token operator">:</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>
    <span class="token constant">IS_READONLY</span><span class="token operator">:</span> <span class="token string">'__v_isReadonly'</span><span class="token punctuation">,</span>
    <span class="token constant">IS_SHALLOW</span><span class="token operator">:</span> <span class="token string">'__v_isShallow'</span><span class="token punctuation">,</span>
    <span class="token constant">RAW</span><span class="token operator">:</span> <span class="token string">'__v_raw'</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello world'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> isObj1Proxy <span class="token operator">=</span> <span class="token function">isProxy</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">;</span> 

  <span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello world'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> isObj2Proxy <span class="token operator">=</span> <span class="token function">isProxy</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    obj1 is proxy<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>isObj1Proxy<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    obj2 is proxy<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>isObj2Proxy<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p><code>isObj1Proxy</code>是<code>true</code>, <code>isObj2Proxy</code>是<code>false</code>, 具体<a href="https://sfc.vuejs.org/#eyJBcHAudnVlIjoiPHNjcmlwdCBzZXR1cD5cbiAgaW1wb3J0IHsgcmVhY3RpdmUsIGlzUHJveHkgfSBmcm9tICd2dWUnO1xuXG4gIGNvbnN0IFJlYWN0aXZlRmxhZ3MgPSB7XG4gICAgU0tJUDogJ19fdl9za2lwJyxcbiAgICBJU19SRUFDVElWRTogJ19fdl9pc1JlYWN0aXZlJyxcbiAgICBJU19SRUFET05MWTogJ19fdl9pc1JlYWRvbmx5JyxcbiAgICBJU19TSEFMTE9XOiAnX192X2lzU2hhbGxvdycsXG4gICAgUkFXOiAnX192X3JhdydcbiAgfVxuXG4gIGNvbnN0IG9iajEgPSByZWFjdGl2ZSh7bXNnOiAnaGVsbG8gd29ybGQnfSk7XG5cbiAgY29uc3QgaXNPYmoxUHJveHkgPSBpc1Byb3h5KG9iajEpOyBcblxuICBjb25zdCBvYmoyID0gcmVhY3RpdmUoKCgpID0+IHtcbiAgICBjb25zdCBvYmogPSB7bXNnOiAnaGVsbG8gd29ybGQnfTtcbiAgICBvYmpbUmVhY3RpdmVGbGFncy5TS0lQXSA9IHRydWU7XG4gICAgXG4gICAgcmV0dXJuIG9iajtcbiAgfSkoKSk7XG5cbiAgY29uc3QgaXNPYmoyUHJveHkgPSBpc1Byb3h5KG9iajIpOyBcbjwvc2NyaXB0PlxuXG48dGVtcGxhdGU+XG4gIDxkaXY+XG4gICAgb2JqMSBpcyBwcm94eToge3tpc09iajFQcm94eX19XG4gIDwvZGl2PlxuICA8ZGl2PlxuICAgIG9iajIgaXMgcHJveHk6IHt7aXNPYmoyUHJveHl9fVxuICA8L2Rpdj5cbjwvdGVtcGxhdGU+IiwiaW1wb3J0LW1hcC5qc29uIjoie1xuICBcImltcG9ydHNcIjoge1xuICAgIFwidnVlXCI6IFwiaHR0cHM6Ly9zZmMudnVlanMub3JnL3Z1ZS5ydW50aW1lLmVzbS1icm93c2VyLmpzXCJcbiAgfVxufSJ9" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>在此</p> <h3 id="shallowreactive"><a href="#shallowreactive" class="header-anchor">#</a> shallowReactive</h3> <p>创建一个响应式代理, 它跟踪其自身<code>property</code>的响应性, 但不执行嵌套对象的深层响应式转换 (暴露原始值).</p> <p>我们最开始就说过, <code>proxy</code>本身是不会对深层对象进行代理的, 而我们去实现对深层对象的代理是通过递归实现的. 那么很显然我们只需要在递归的时候加一个判断条件就能实现这个<code>api</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isReadonly<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们是把<code>get</code>函数的创建给单独抽了出来, 像之前那样, 通过传参数的方式去控制创建各种<code>get</code>.</p> <h3 id="shallowreadonly"><a href="#shallowreadonly" class="header-anchor">#</a> shallowReadonly</h3> <p>创建一个<code>proxy</code>, 使其自身的<code>property</code>为只读, 但不执行嵌套对象的深度只读转换 (暴露原始值).</p> <p>同理, 我们可以和<code>shallowReactive</code>公用一个<code>createGetter</code>函数:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">shallowReadonly</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>只需要将传给<code>createGetter</code>的第一个参数从<code>false</code>改为<code>true</code>就行了.</p> <h2 id="refs"><a href="#refs" class="header-anchor">#</a> Refs</h2> <h3 id="ref"><a href="#ref" class="header-anchor">#</a> ref</h3> <p>接受一个内部值并返回一个响应式且可变的<code>ref</code>对象. <code>ref</code>对象仅有一个<code>.value property</code>, 指向该内部值. 如果将对象分配为<code>ref</code>值, 则它将被<code>reactive</code>函数处理为深层的响应式对象.</p> <p>我们在介绍<code>reactive</code>的时候就说过, <code>proxy</code>只能代理对象, 那么对于 <code>String</code>、<code>Number</code>这些类型改如何处理呢? <code>vue</code>提供了<code>ref api</code>可以用来处理这些值, 从介绍来看, 我们可以用<code>.value</code>来获取对应的值, 从这个行为也能看出内部一定是一个对象, 所以就相当于<code>vue</code>帮助我们包装了一个对象.</p> <p>下面的问题就是如何让这个对象具有响应性. 不知道大家是否还记得我们之前在介绍<code>effect</code>的时候提到了两个函数<code>track</code>、<code>trigger</code>, 同时, 我们还通过这两个函数让一个非响应式对象具有了响应性, 忘了的同学可以点击<a href="https://play.vueuse.org/#N4IgDghgxg1hDmBTAziAXAbVAOwgW0XRADcBXRAWgBNE8BLEAGhGQHtSAnKQtEU7MDHhMQNZFA50wAFzqtsRAGrkABABFadFQAoAFhAA2AMxV1sKgGIdE2KLoCUp5CogqaxRAdZgz8FaVkDOmkATxcDLwB3ZxD2FWlWFUjJaUQVAFVsOg8OZEMVZTSAGToAIw4ISRQVI1YOAtUAJhUAMhUAZhFOAyJdaWkwZDQAemH+QXgAOihWPGGyShp6YaDS4bMaAA9JvAArVABfRhx8HhAAAQXSZERh5H1rKhE2Tm4icaERMQkpWXkiADKD0QVAaiHSN38gWCdBQky6HB6vD6AyGow+Uxmc0u5Gut3ulRB5wArJMAAyTACM62wW0mKDwk32ICOJwIRBxiDxwxm1me7C4ZwxXxQPxkcgUvAAwqwIogoH9zKwTCgbthZPlCioZXgwKxkDD5BlobIUAikSAUYMRmMBEJprNhpzubzECTyVSaXSGUzDscQLh2bxOcNrNBZMRgiFzb1+tbRlAqNhJsgYCFILBJu4nQtQ4hw9koyLxJJxf9g7mwwrC6ERDkDeWQEUIKlkNJ+a8zqn09AYCyALrMIx0AxmtCgACCYDAkwW6FAqV1BhbZwAPKUAglzOcoEFYABeAA6IGkkngSA4AFEPOrjwA+QCdDoBEI0AZ5GAReVAPZKgB15QAUrqvhhu-TyHezxiu2vB0LqdTSCowAqIgRhGPK0iMPEZ4Xqhp69ioBw1BwswqMeIZVhGUbHgA3Ie2BUTM2BtioAAqFSwAA8mADHptU+6wVRKgqAA4peDFoIRIBINIx6MLxKgABITgCInHvoyCSdJACSDGXgAShOmmKSAwSIBUqSqdgByUdRtjyPRTF0OeRlsRxYBcTx5gqACQn6TcElMNJE5qGo+kQFQVCmXxaiXkUQmXvpNCjiZvluVKUUTlp+m7vmHCmeZVFUaMKjvqedkXoAv4qAA6mqE-vEnEqAA1CoMCIGEgB+Rt+P40dZMFFfZV43jB3HaI4+53mhxVGdorClLsqG2T1jmccgkweQxqHHngyDwMe9gWR1dEwZNuwqNxcHrfA+m6J4XhJHUBihSAOE7dgCFIQq2iDUdI3ANJ+WAKrGgDtwYAyvqALJKbXlZV1XOXVDVNSogAEZoAIDrSVhsATVNM3MTA83OYtgkraJp1bRZfGGEZ0io7sOwbfYVEHNtuXYAdlN+NxSmXYkkQ3VQACEPM8xRVHdRe142GT20sswMp1FQZgrrO5DzietBgMuqREKu0vENJtTqkeIB4PIrDHtJpTwLrQTwH0FDEmSZJuJUMBoFQ9tWzbRtuUYo6bLrAB+KgzAYbt8akmzSLr3DqkZgcqGAuuNFHpRS0Zuv4fwNB3VRd7SauyCQOYweh8eAAsmwByAd7AHBxCGKoBwHP+OcQNgmdudnufxIgIe68geB2xwDvm5bACcNu9w73jQFGLvHioeC69IFBx2XACy7CQhXKjLqUng4XXdy583-4ayBzAlr8RCQXqHAwXBNDDk9AAK+GDDheEEQA5Asb-07fZiII-3jIG0F9Nym9PAiQBEVbA8ApJuSrgYcgIkABypA8Bbw4DA2mLJa5AA" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>回顾一下.</p> <p>所以接下来的问题就简单了, 我们就借助这两个函数让我们封装的对象具有响应性.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> TrackOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">GET</span><span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token constant">HAS</span><span class="token operator">:</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token constant">ITERATE</span><span class="token operator">:</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> TriggerOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">SET</span><span class="token operator">:</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token constant">ADD</span><span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token constant">CLEAR</span><span class="token operator">:</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Ref</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">track</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newValue <span class="token operator">!=</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ref</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们用之前实现过的 <code>effect</code> 来验证一下, 看看是否具有响应性:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> TrackOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">GET</span><span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token constant">HAS</span><span class="token operator">:</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token constant">ITERATE</span><span class="token operator">:</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> TriggerOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">SET</span><span class="token operator">:</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token constant">ADD</span><span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token constant">CLEAR</span><span class="token operator">:</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> effectMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeEffect <span class="token operator">=</span> f<span class="token punctuation">;</span>
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 收集副作用, 以 obj 为对象</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 副作用属于该对象的哪个属性</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果当前有活跃的副作用, 将其收集起来</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 触发副作用</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发哪个 key 的副作用</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 运行 key 里面的副作用</span>
  dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Ref</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">track</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newValue <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ref</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> refObj <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>refObj<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

refObj<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">// 2</span>
</code></pre></div><p>当 <code>effect</code> 首次运行的时候会输出 <code>1</code>, 当<code>ref</code>的<code>value</code>被改变的时候会再次触发副作用函数, 输出<code>2</code>, 这样我们就让一个普通对象具有了响应性. 至于第二句话: 如果将对象分配为<code>ref</code>值, 则它将被<code>reactive</code>函数处理为深层的响应式对象.</p> <p>那么我们只要判断一下这个值是否时对象, 再调用<code>reactive</code>处理一下是不是就大功告成了.</p> <h3 id="isref"><a href="#isref" class="header-anchor">#</a> isRef</h3> <p>检查值是否为一个<code>ref</code>对象</p> <p>注意我们之前<code>ref</code>的实现中, 里面有一个<code>__v_isRef</code>, 这个值就代表了这是个<code>ref</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>ref<span class="token punctuation">.</span>__v_isRef<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="unref"><a href="#unref" class="header-anchor">#</a> unref</h3> <p>如果参数是一个<code>ref</code>, 则返回内部值, 否则返回参数本身.这是 <code>val = isRef(val) ? val.value : val</code> 的语法糖函数.</p> <p>这句话本身就说的非常清楚了, 这是为了方便我们使用<code>value</code>值, 毕竟如果是<code>ref</code>, 我们必须使用<code>.value</code>才能拿到真正的值.</p> <h3 id="torefs"><a href="#torefs" class="header-anchor">#</a> toRefs</h3> <p>将响应式对象转换为普通对象, 其中结果对象的每个<code>property</code>都是指向原始对象相应<code>property</code>的<code>ref</code>.</p> <p>我们之前说过, <code>proxy</code>如果被解构之后会失去响应性, 那么如果我们想在解构之后还能保持响应性就必须做一些额外的处理. 我们仔细想想, 失去响应性的主要原因是这个变量被赋值给了另一个普通变量, 如果我们每次拿值的时候都从原始的响应式对象上拿, 这样我们就能始终保持响应性了.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ObjectRefImpl</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_key <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_key<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toRefs</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectRefImpl</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样, 我们每次使用解构后的值时, 都会从原始<code>proxy</code>对象上取值, 这样就会触发原始<code>proxy</code>的<code>get</code>、<code>set</code>, 从而保持响应性. 同样, 我们来测试一下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> effectMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeEffect <span class="token operator">=</span> f<span class="token punctuation">;</span>
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 收集副作用, 以 obj 为对象</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 副作用属于该对象的哪个属性</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果当前有活跃的副作用, 将其收集起来</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 触发副作用</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发哪个 key 的副作用</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 运行 key 里面的副作用</span>
  dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ObjectRefImpl</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_key <span class="token operator">=</span> key<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_key<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toRefs</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectRefImpl</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'klx'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span>value<span class="token punctuation">,</span> age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// klx 10</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

age<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">// klx 11</span>
</code></pre></div><p>可以看到, 当我们修改<code>age</code>的值时, 是能够触发副作用函数的, 大家也可以试试直接从<code>obj</code>里面解构, 再看看能不能触发<code>effect</code>的副作用.</p> <h3 id="toref"><a href="#toref" class="header-anchor">#</a> toRef</h3> <p>可以用来为源响应式对象上的某个<code>property</code>新创建一个<code>ref</code>. 然后, <code>ref</code>可以被传递, 它会保持对其源<code>property</code>的响应式连接.</p> <p>可以看到, <code>toRef</code>和<code>toRefs</code>非常像, 只是<code>toRef</code>是针对单个<code>props</code>. 而还有一个显著区别是, 如果<code>obj</code>上不存在某个<code>props</code>, 那么<code>toRefs</code>是不会进行处理的, 但是<code>toRef</code>还是会返回一个可用的<code>ref</code>. 因为我们之前是通过遍历<code>obj</code>的<code>key</code>来进行处理的, 如果某个可选<code>props</code>没有, 那自然不会进行处理.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ObjectRefImpl</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_key <span class="token operator">=</span> key<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_key<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toRef</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjectRefImpl</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实现上也非常简单, 和<code>toRefs</code>基本上一样.</p> <h3 id="customref"><a href="#customref" class="header-anchor">#</a> customRef</h3> <p>创建一个自定义的<code>ref</code>, 并对其依赖项跟踪和更新触发进行显式控制.它需要一个工厂函数, 该函数接收<code>track</code>和<code>trigger</code>函数作为参数, 并且应该返回一个带有<code>get</code>和<code>set</code>的对象.</p> <p><code>customRef</code> 主要是让开发者自己控制什么时候触发依赖跟踪和更新, 其实经过上面这么多的介绍, 我们不使用<code>customRef</code>也能用它提供的<code>track</code>和<code>trigger</code>函数来实现一个自己的<code>customRef</code>. 这个函数主要是把内部的函数通过传参的形式暴露给了开发者, 让大家少一点心智负担. 其实工厂函数接受的<code>track</code>和<code>trigger</code>就是我们之前一直在说的两个函数.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CustomRef</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>get<span class="token punctuation">,</span> set<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 传递给开发者的 track 函数</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 传递给开发者的 trigger 函数</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_get <span class="token operator">=</span> get<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_set <span class="token operator">=</span> set<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">customRef</span><span class="token punctuation">(</span><span class="token parameter">factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomRef</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样, 开发者在调用<code>track</code>、<code>trigger</code>的时候, 实际上还是通过<code>OpTypes</code>+<code>key</code>建立映射关系, 实现响应性. 但是现在就把调用的权利交给了开发者, 让他自己控制.</p> <h3 id="shallowref"><a href="#shallowref" class="header-anchor">#</a> shallowRef</h3> <p>创建一个跟踪自身<code>.value</code>变化的<code>ref</code>, 但不会使其值也变成响应式的.</p> <p>其实我们上面实现的<code>ref</code>本身就没有对<code>value</code>再进行处理, <code>vue</code>本身会将其处理为响应式对象, 那么, 如果我们不想讲其变成响应式对象, 只要加一个判断条件是不是就行了?</p> <div class="language-js extra-class"><pre class="language-js"><code>isObject <span class="token operator">&amp;&amp;</span> isShallow <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>
</code></pre></div><p>就类似这样, 是不是很简单.</p> <h3 id="triggerref"><a href="#triggerref" class="header-anchor">#</a> triggerRef</h3> <p>手动执行与<code>shallowRef</code>关联的任何作用 (<code>effect</code>).</p> <p>到这里我们已经非常熟悉<code>track</code>和<code>trigger</code>函数了. 我们知道, 我们如果想触发副作用就必须触发<code>trigger</code>. 但是如果我们使用了<code>shallowRef</code>, 其下面的<code>value</code>是不会具有响应性的. 所以自然也不会触发<code>trigger</code>, 不会触发<code>effect</code>.</p> <p>所以我们就可以手动去触发<code>trigger</code>, 让它触发副作用.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">triggerRef</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>value<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 并不会触发响应式</span>
ref<span class="token punctuation">.</span>value<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">// 强制触发 effect 副作用</span>
<span class="token function">triggerRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样, 我们就能触发这个 <code>Optypes</code>+<code>key</code> 所绑定的副作用.</p> <h2 id="computed-与-watch"><a href="#computed-与-watch" class="header-anchor">#</a> Computed 与 watch</h2> <h3 id="computed"><a href="#computed" class="header-anchor">#</a> computed</h3> <p>接受一个<code>getter</code>函数, 并根据<code>getter</code>的返回值返回一个不可变的响应式<code>ref</code>对象. 或者, 接受一个具有<code>get</code>和<code>set</code>函数的对象, 用来创建可写的<code>ref</code>对象.</p> <p>这个 <code>computed</code> 就是我们常说的计算属性, 他有一个非常重要的特点就是会缓存之前的结果. 只有当它所依赖的值发生改变的时候才会重新计算结果, 否则不会再执行之前的函数而是返回之前的结果. 同时它的计算是惰性的, 也就是说只有在你真正使用这个值的时候才会去计算. 如果你只声明但是没有使用, 这个<code>getter</code>函数是永远不会执行的. 我们一步步来实现一下 <code>computed</code>, 先不用考虑缓存、惰性求值之类的东西.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> refObj <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    refObj<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> refObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实只有这么简单几行代码我们就能实现一个超级简单的<code>computed</code>. 在<code>getter</code>运行的时候内部使用到的响应式变量都会触发<code>track</code>, 这样就把<code>effect</code>副作用收集了起来. 当后面这些值的<code>setter</code>被触发之后, 就会重新触发副作用, 进而重新对<code>refObj.value</code>进行赋值, 所以我们就能拿到最新的值了. 我们来简单试一试</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> TrackOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">GET</span><span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token constant">HAS</span><span class="token operator">:</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token constant">ITERATE</span><span class="token operator">:</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> TriggerOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">SET</span><span class="token operator">:</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token constant">ADD</span><span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token constant">CLEAR</span><span class="token operator">:</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> effectMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeEffect <span class="token operator">=</span> f<span class="token punctuation">;</span>
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 收集副作用, 以 obj 为对象</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 副作用属于该对象的哪个属性</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果当前有活跃的副作用, 将其收集起来</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 触发副作用</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发哪个 key 的副作用</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 运行 key 里面的副作用</span>
  dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Ref</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">track</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newValue <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ref</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> refObj <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    refObj<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> refObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'klx'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">.</span>age <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 40</span>

obj<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 42</span>
</code></pre></div><p>当我们改变<code>obj.age</code>的值之后, <code>age</code>的值也随之改变了, 符合预期. 那么接下来我们来看看如何避免重复计算以及惰性计算.</p> <p>其实真正的<code>effect</code>函数有一个<code>lazy</code>的变量可以传递, 这样<code>effect</code>就不会立即执行. 执行完<code>effect</code>会返回一个<code>run</code>函数, 调用<code>run</code>函数的时候才会真正执行. 同时<code>effect</code>还能接受一个<code>scheduler</code>(调度器)的参数, <code>effect</code>里面的变量被改变触发副作用时, 并不运行传给<code>effect</code>的回调函数, 而是运行用户自定义的调度器, 也就是<code>scheduler</code>函数. 所以我们可以把<code>effect</code>进行一些改造:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> lazy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      activeEffect <span class="token operator">=</span> scheduler <span class="token operator">?</span> scheduler <span class="token operator">:</span> f<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> run<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么显然, <code>computed</code> 其实就是一个<code>lazy</code>的<code>effect</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> refObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> refObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样, 只有在我们真的使用了<code>refObj.value</code>的时候, 才会执行到<code>get</code>函数, 从而触发<code>effect</code>的执行. 大家可以自己修改一下代码尝试一下. 那么第二个问题就是如何避免多次重复执行. 可以看到, 现在的实现中, 无论我们的依赖有没有改变, <code>run</code>函数每次必定都会执行, 那么什么时候该执行什么时候不该执行? 首先第一次肯定需要跑一遍<code>run</code>函数我们才能拿到真正的结果. 但是在后面的过程中, 如果<code>effect</code>依赖的那些值都没有变化的话, 那我们就没有必要再次运行<code>run</code>函数了, 因为依赖的值不变得到的结果肯定还是一样的.</p> <p>所以我们弄一个<code>dirty</code>的变量来判断<code>effect</code>所依赖的值是否发生了变化, 这个时候就用到了<code>scheduler</code>函数. 那么<code>dirty</code>什么情况下才应该是<code>true</code>?</p> <ol><li>首次默认值为<code>true</code></li> <li><code>computed</code>内部依赖的值发生了改变</li></ol> <p>而在依赖值改变的时候, 会触发<code>effect</code>的副作用函数, 所以我们在这个时机把<code>dirty</code>的值修改为<code>true</code>就好了.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> refObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> refObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们把结果保存起来, 在<code>dirty</code>为<code>false</code>的时候不再运行<code>run</code>函数, 这样就能实现值的缓存. 我们来完整跑一跑:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> TrackOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">GET</span><span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token constant">HAS</span><span class="token operator">:</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token constant">ITERATE</span><span class="token operator">:</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> TriggerOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">SET</span><span class="token operator">:</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token constant">ADD</span><span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token constant">CLEAR</span><span class="token operator">:</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> effectMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> lazy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      activeEffect <span class="token operator">=</span> scheduler <span class="token operator">?</span> scheduler <span class="token operator">:</span> f<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> run<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 收集副作用, 以 obj 为对象</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 副作用属于该对象的哪个属性</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果当前有活跃的副作用, 将其收集起来</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 触发副作用</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发哪个 key 的副作用</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 运行 key 里面的副作用</span>
  dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> refObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> refObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'klx'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;computed 执行了&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">.</span>age <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// computed 执行了</span>
<span class="token comment">// 40</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 40</span>
</code></pre></div><p>可以看到, 第二次使用<code>age.value</code>的时候已经不会执行<code>computed</code>的函数了. 其实还有一个问题就是, 我们现在这样写, 返回的对象是没有响应性的, <code>computed</code>实际上会返回一个<code>ref</code>, 是具有响应性的. 那么这个要怎么写了, 我已经不会写了, 大家帮我实现一下(是不是用<code>track</code>、<code>trigger</code>就行了?).</p> <h3 id="watcheffect"><a href="#watcheffect" class="header-anchor">#</a> watchEffect</h3> <p>立即执行传入的一个函数, 同时响应式追踪其依赖, 并在其依赖变更时重新运行该函数.</p> <p>从描述来看这个和我们之前介绍的<code>effect</code>函数非常像, 其实<code>watchEffect</code>底层依赖的就是<code>effect</code>, 但是它比<code>effect</code>做了更多的事情, 例如:</p> <ol><li>会根据实际情况自动<code>stop</code>. 例如组件被卸载的时候</li> <li>会通过队列去调用副作用, 避免多次重复调用, 例如多次触发同一个变量的<code>set</code>, 最终只会执行一次副作用.</li> <li>接受一个<code>flush</code>参数, 支持自定义副作用调用时机.</li></ol> <p>个人认为, 也正因为如此, 它并不是一个纯粹的响应式api, 所以它不随着<code>@vue/reactivity</code>一起暴露出来, 而是和<code>watch</code>函数一起放在了<code>@vue/runtime-core</code>中. 我们主要看看它的多次调用触发一次副作用如何实现? 还记得之前说过<code>effect</code>支持传入一个调度器的参数吗, 其实我们借助这个参数就能实现这个功能.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> f <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们维护一个队列, 将要执行的副作用函数放入其中, 每次执行之前先判断这个副作用函数是否在队列中, 再决定是否入栈. 最后利用<code>js</code>的事件循环将真正的执行放到微任务队列中去执行. 而要想实现<code>flush</code>参数, 其实也是在调度器里面做文章, 例如在<code>flush</code>等于<code>sync</code>的情况下就直接运行副作用函数, 从而让用户去控制副作用函数执行时机. 我们可以看看效果:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> TrackOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">GET</span><span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token constant">HAS</span><span class="token operator">:</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token constant">ITERATE</span><span class="token operator">:</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> TriggerOpTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">SET</span><span class="token operator">:</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token constant">ADD</span><span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token constant">CLEAR</span><span class="token operator">:</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> effectMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> lazy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      activeEffect <span class="token operator">=</span> scheduler <span class="token operator">?</span> scheduler <span class="token operator">:</span> f<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> run<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 收集副作用, 以 obj 为对象</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 副作用属于该对象的哪个属性</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果当前有活跃的副作用, 将其收集起来</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// _type 在我们这里是无用参数</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 触发副作用</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> effectMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发哪个 key 的副作用</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 运行 key 里面的副作用</span>
  dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> f <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 首次执行输出 20</span>

obj<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">// 全部加完之后输出 23</span>
</code></pre></div><p>这样就避免了无用的副作用运行. 所以我们在日常开发中使用<code>watchEffect</code>就行了, <code>effect</code>只是它底层依赖的<code>api</code>而已(毕竟官网都没说明的<code>api</code>).</p> <h3 id="watchposteffect"><a href="#watchposteffect" class="header-anchor">#</a> watchPostEffect</h3> <p><code>watchEffect</code>的别名, 带有 flush: 'post' 选项, 等效于:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">'post'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="watchsynceffect"><a href="#watchsynceffect" class="header-anchor">#</a> watchSyncEffect</h3> <p><code>watchEffect</code>的别名, 带有 flush: 'sync' 选项, 等效于:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">'sync'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="watch"><a href="#watch" class="header-anchor">#</a> watch</h3> <p><code>watch API</code> 与选项式 <code>API this.$watch</code> (以及相应的 <code>watch</code> 选项) 完全等效.<code>watch</code> 需要侦听特定的数据源, 并在单独的回调函数中执行副作用.默认情况下, 它也是惰性的——即回调仅在侦听源发生变化时被调用.</p> <p>这个函数支持监听一个<code>ref</code>对象, 监听<code>reactive</code>对象, 也支持传入一个函数, 监听内部依赖的变量, 同时也支持传递数组. 这个方法实现的思路其实也很简单, 将传入的监听内容封装为一个 <code>getter</code> 函数, 将其放到<code>effect</code>中去, 在副作用触发时通过调度器执行对应回调函数就行了. 例如这样:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">reactiveObj<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> reactiveObj
  <span class="token punctuation">}</span>

  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是有一个地方需要注意, 这个函数有一个<code>deep</code>参数, 是用来控制是否监听对象内部值的变化. 因为当你传入一个<code>reactive</code>对象的时候, <code>getter</code>函数并没有使用到<code>reactive</code>内部的值, 自然不会<code>track</code>副作用. 那么你再修改<code>reactive</code>内部值的时候, 自然也不会被监听到.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> Vue<span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'klx'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;obj 被修改&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 正确写法</span>
<span class="token comment">// watch(() =&gt; obj, () =&gt; {</span>
<span class="token comment">//   console.log(&quot;obj 被修改&quot;, obj);</span>
<span class="token comment">// }, {</span>
<span class="token comment">//   deep: true,</span>
<span class="token comment">// });</span>

obj<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">// 并不会触发 watch</span>
</code></pre></div><p>我们可能注意到这里是使用函数去返回了一个<code>reactive</code>, 如果你直接给<code>watch</code>传一个<code>reactive</code>会发现它是能够成功的监听到内部值的改变的, 这是因为当你单独传入<code>reactive</code>时, <code>vue</code>内部帮你把<code>deep</code>置为<code>true</code>了, 其他情况下默认值为<code>false</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> source
  deep <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre></div><p>而当你传入<code>deep: true</code>时, <code>vue</code>会自动通过<code>traverse</code>函数帮你遍历对象下的所有属性:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> unknown<span class="token punctuation">,</span> seen<span class="token operator">?</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>value <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>
  seen <span class="token operator">=</span> seen <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>
  seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>value<span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isMap</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">v</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">traverse</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> value
<span class="token punctuation">}</span>
</code></pre></div><p>这样, 就会触发所有<code>props</code>的<code>get</code>, 从而<code>track</code>到副作用, 实现深层监听.</p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>至此, 终于把官网上介绍的响应性 API 介绍完了, 其实还有一个 <code>Effect 作用域 API</code>, 这个<code>API</code>的源码其实也非常简单, 大家感兴趣的自己去看就好了.</p> <p>这一系列文章只是为了让大家更加深入的了解<code>vue</code>实现响应式背后的原理, <code>vue</code> 的所有响应式操作都依赖这些基础<code>api</code>实现. 而文中所列出的代码也不是<code>vue</code>的真正实现, 都是一个最基础的能跑的<code>demo</code>, 非常多的情况是没有考虑进去的. 但是已经足够让大家对于它背后的原理有一定的了解. 如果想真正看看<code>vue</code>到底是如何处理各种递归、调度、优化依赖收集的部分, 还是建议大家自己去阅读一下源码.</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ol><li><a href="https://github.com/vuejs/core" target="_blank" rel="noopener noreferrer">github源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://v3.cn.vuejs.org/api/reactivity-api.html" target="_blank" rel="noopener noreferrer">官网文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>vue core team 成员 HcySunYang <a href="https://zhuanlan.zhihu.com/p/146097763" target="_blank" rel="noopener noreferrer">博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue/vue%E5%B7%A5%E7%A8%8B%E5%8C%96/" class="prev">
        vue工程化
      </a></span> <!----></p></div>  <!----></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b8096a98.js" defer></script><script src="/assets/js/21.bf7b29c4.js" defer></script><script src="/assets/js/2.f7c58a73.js" defer></script><script src="/assets/js/19.dc652960.js" defer></script>
  </body>
</html>
